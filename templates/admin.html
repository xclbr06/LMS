<!DOCTYPE html>
<html>
<head>
    <title>Admin Panel - School Library Management System</title>
    <link rel="stylesheet" href="../styles/style.css">
    <link rel="stylesheet" href="../styles/admin.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="body-bg">
        <img src="../img/school.jpg" alt="Background" class="bg-img">
        <div class="bg-overlay"></div>
    </div>
    <?php include '../php/navbar.php'; ?>
    <?php
    // At the top of your template, before any HTML output:
    $activeTab = $_GET['activeTab'] ?? 'inventory';
    ?>
    <div class="container mt-5">
        <h1>Admin Panel</h1>
        <ul class="nav nav-tabs" id="adminTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link <?= $activeTab=='inventory'?'active':'' ?>" id="inventory-tab" data-bs-toggle="tab" data-bs-target="#inventory" type="button" role="tab">Inventory</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link <?= $activeTab=='categories'?'active':'' ?>" id="categories-tab" data-bs-toggle="tab" data-bs-target="#categories" type="button" role="tab">Categories</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link <?= $activeTab=='users'?'active':'' ?>" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">Users</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link <?= $activeTab=='reservations'?'active':'' ?>" id="reservations-tab" data-bs-toggle="tab" data-bs-target="#reservations" type="button" role="tab">Reservations</button>
            </li>
        </ul>
        <div class="tab-content" id="adminTabContent">
            <!-- Inventory Tab -->
            <div class="tab-pane fade <?= $activeTab=='inventory'?'show active':'' ?>" id="inventory" role="tabpanel">
                <div class="section-title d-flex justify-content-between align-items-center">
                    Inventory
                    <button type="button" class="btn btn-primary btn-add-main" data-bs-toggle="modal" data-bs-target="#addBookModal" id="openAddBookModal">
                        Add Book
                    </button>
                </div>
                <form method="get" class="row g-2 align-items-center mb-3">
                    <input type="hidden" name="activeTab" value="inventory">
                    <div class="col-md-4">
                        <input type="text" class="form-control filter-control" name="inventorySearch" value="<?= htmlspecialchars($_GET['inventorySearch'] ?? '') ?>" placeholder="Search Inventory">
                    </div>
                    <div class="col-md-3">
                        <select class="form-select filter-control" name="inventorySortField">
                            <option value="id" <?= ($_GET['inventorySortField'] ?? '')=='id'?'selected':''; ?>>ID</option>
                            <option value="title" <?= ($_GET['inventorySortField'] ?? '')=='title'?'selected':''; ?>>Title</option>
                            <option value="author" <?= ($_GET['inventorySortField'] ?? '')=='author'?'selected':''; ?>>Author</option>
                            <option value="category" <?= ($_GET['inventorySortField'] ?? '')=='category'?'selected':''; ?>>Category</option>
                            <option value="availability_status" <?= ($_GET['inventorySortField'] ?? '')=='availability_status'?'selected':''; ?>>Status</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select filter-control" name="inventorySortOrder">
                            <option value="asc" <?= ($_GET['inventorySortOrder'] ?? '')=='asc'?'selected':''; ?>>Ascending</option>
                            <option value="desc" <?= ($_GET['inventorySortOrder'] ?? '')=='desc'?'selected':''; ?>>Descending</option>
                        </select>
                    </div>
                    <div class="col-md-3 text-end">
                        <button type="submit" class="btn btn-primary btn-sm btn-action filter-control">Search/Sort</button>
                    </div>
                </form>
                <table class="table table-striped table-hover table-sm align-middle" id="inventoryTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Title</th>
                            <th>Author</th>
                            <th>Category</th>
                            <th>Copies</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php foreach ($books as $book): ?>
                        <tr>
                            <form method="post" class="d-flex">
                                <td>
                                    <input type="hidden" name="book_id" value="<?= $book['id'] ?>">
                                    <input type="text" name="id" class="form-control form-control-sm input-short" value="<?= $book['id'] ?>" readonly>
                                </td>
                                <td>
                                    <input type="text" name="title" class="form-control form-control-sm" value="<?= htmlspecialchars($book['title']) ?>">
                                </td>
                                <td>
                                    <input type="text" name="author" class="form-control form-control-sm" value="<?= htmlspecialchars($book['author']) ?>">
                                </td>
                                <td>
                                    <input type="text" name="category" class="form-control form-control-sm" value="<?= htmlspecialchars($book['category']) ?>">
                                </td>
                                <td>
                                    <input type="number" name="copies" class="form-control form-control-sm input-short" value="<?= $book['copies'] ?>">
                                </td>
                                <td>
                                    <select name="availability_status" class="form-select form-select-sm">
                                        <option value="available" <?= $book['availability_status']=='available'?'selected':''; ?>>Available</option>
                                        <option value="unavailable" <?= $book['availability_status']=='unavailable'?'selected':''; ?>>Unavailable</option>
                                    </select>
                                </td>
                                <td>
                                    <button type="submit" name="edit_book" class="btn btn-success btn-sm btn-action">Save</button>
                                    <button type="submit" name="delete_book" class="btn btn-danger btn-sm btn-action" onclick="return confirm('Delete this book?');">Delete</button>
                                </td>
                            </form>
                        </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
            </div>
            <!-- Categories Tab -->
            <div class="tab-pane fade <?= $activeTab=='categories'?'show active':'' ?>" id="categories" role="tabpanel">
                <div class="section-title d-flex justify-content-between align-items-center">
                    Categories
                    <button type="button" class="btn btn-primary btn-add-main" data-bs-toggle="modal" data-bs-target="#addCategoryModal" id="openAddCategoryModal">
                        Add Category
                    </button>
                </div>
                <form method="get" class="row g-2 align-items-center mb-3">
                    <input type="hidden" name="activeTab" value="categories">
                    <div class="col-md-6">
                        <input type="text" class="form-control filter-control" name="categorySearch" value="<?= htmlspecialchars($_GET['categorySearch'] ?? '') ?>" placeholder="Search Categories">
                    </div>
                    <div class="col-md-3">
                        <select class="form-select filter-control" name="categorySortOrder">
                            <option value="asc" <?= ($_GET['categorySortOrder'] ?? '')=='asc'?'selected':''; ?>>A-Z</option>
                            <option value="desc" <?= ($_GET['categorySortOrder'] ?? '')=='desc'?'selected':''; ?>>Z-A</option>
                        </select>
                    </div>
                    <div class="col-md-3 text-end">
                        <button type="submit" class="btn btn-primary btn-sm btn-action filter-control">Search/Sort</button>
                    </div>
                </form>
                <table class="table table-striped table-hover table-sm align-middle" id="categoriesTable">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php foreach ($categories as $cat): ?>
                        <tr>
                            <form method="post" class="d-flex">
                                <td>
                                    <input type="text" name="category" class="form-control form-control-sm" value="<?= htmlspecialchars($cat['category']) ?>">
                                    <input type="hidden" name="original_category" value="<?= htmlspecialchars($cat['category']) ?>">
                                </td>
                                <td>
                                    <button type="submit" name="edit_category" class="btn btn-success btn-sm btn-action">Save</button>
                                    <button type="submit" name="delete_category" class="btn btn-danger btn-sm btn-action" onclick="return confirm('Delete this category?');">Delete</button>
                                </td>
                            </form>
                        </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
            </div>
            <!-- Users Tab -->
            <div class="tab-pane fade <?= $activeTab=='users'?'show active':'' ?>" id="users" role="tabpanel">
                <div class="section-title d-flex justify-content-between align-items-center">
                    Users
                    <button type="button" class="btn btn-primary btn-add-main" data-bs-toggle="modal" data-bs-target="#addUserModal" id="openAddUserModal">
                        Add User
                    </button>
                </div>
                <form method="get" class="row g-2 align-items-center mb-3">
                    <input type="hidden" name="activeTab" value="users">
                    <div class="col-md-4">
                        <input type="text" class="form-control filter-control" name="userSearch" value="<?= htmlspecialchars($_GET['userSearch'] ?? '') ?>" placeholder="Search Users">
                    </div>
                    <div class="col-md-4">
                        <select class="form-select filter-control" name="userSortField">
                            <option value="first_name" <?= ($_GET['userSortField'] ?? '')=='first_name'?'selected':''; ?>>First Name</option>
                            <option value="last_name" <?= ($_GET['userSortField'] ?? '')=='last_name'?'selected':''; ?>>Last Name</option>
                            <option value="email" <?= ($_GET['userSortField'] ?? '')=='email'?'selected':''; ?>>Email</option>
                            <option value="role" <?= ($_GET['userSortField'] ?? '')=='role'?'selected':''; ?>>Role</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select filter-control" name="userSortOrder">
                            <option value="asc" <?= ($_GET['userSortOrder'] ?? '')=='asc'?'selected':''; ?>>A-Z</option>
                            <option value="desc" <?= ($_GET['userSortOrder'] ?? '')=='desc'?'selected':''; ?>>Z-A</option>
                        </select>
                    </div>
                    <div class="col-md-2 text-end">
                        <button type="submit" class="btn btn-primary btn-sm btn-action filter-control">Search/Sort</button>
                    </div>
                </form>
                <table class="table table-striped table-hover table-sm align-middle" id="usersTable">
                    <thead>
                        <tr>
                            <th>First Name</th>
                            <th>Middle Name</th>
                            <th>Last Name</th>
                            <th>Email</th>
                            <th>Student ID</th>
                            <th>Phone</th>
                            <th>Role</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php foreach ($users as $user): ?>
                        <tr>
                            <form method="post" class="d-flex">
                                <td><input type="text" name="first_name" class="form-control form-control-sm" value="<?= htmlspecialchars($user['first_name']) ?>"></td>
                                <td><input type="text" name="middle_name" class="form-control form-control-sm" value="<?= htmlspecialchars($user['middle_name']) ?>"></td>
                                <td><input type="text" name="last_name" class="form-control form-control-sm" value="<?= htmlspecialchars($user['last_name']) ?>"></td>
                                <td><input type="email" name="email" class="form-control form-control-sm" value="<?= htmlspecialchars($user['email']) ?>"></td>
                                <td><input type="text" name="student_teacher_id" class="form-control form-control-sm" value="<?= htmlspecialchars($user['student_teacher_id']) ?>"></td>
                                <td><input type="text" name="phone" class="form-control form-control-sm" value="<?= htmlspecialchars($user['phone']) ?>"></td>
                                <td>
                                    <select name="role" class="form-select form-select-sm">
                                        <option value="student" <?= $user['role']=='student'?'selected':''; ?>>Student</option>
                                        <option value="teacher" <?= $user['role']=='teacher'?'selected':''; ?>>Teacher</option>
                                        <option value="admin" <?= $user['role']=='admin'?'selected':''; ?>>Admin</option>
                                    </select>
                                </td>
                                <td>
                                    <input type="hidden" name="user_id" value="<?= $user['id'] ?>">
                                    <button type="submit" name="edit_user" class="btn btn-success btn-sm btn-action">Save</button>
                                    <button type="submit" name="delete_user" class="btn btn-danger btn-sm btn-action" onclick="return confirm('Delete this user?');">Delete</button>
                                </td>
                            </form>
                        </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
            </div>
            <!-- Reservations Tab -->
            <div class="tab-pane fade <?= $activeTab=='reservations'?'show active':'' ?>" id="reservations" role="tabpanel">
                <div class="section-title d-flex justify-content-between align-items-center">
                    Reservations
                    <button type="button" class="btn btn-primary btn-add-main" data-bs-toggle="modal" data-bs-target="#addReservationModal" id="openAddReservationModal">
                        Add Reservation
                    </button>
                </div>
                <form method="get" class="row g-2 align-items-center mb-3">
                    <input type="hidden" name="activeTab" value="reservations">
                    <div class="col-md-4">
                        <input type="text" class="form-control filter-control" name="reservationSearch" value="<?= htmlspecialchars($_GET['reservationSearch'] ?? '') ?>" placeholder="Search Reservations">
                    </div>
                    <div class="col-md-4">
                        <select class="form-select filter-control" name="reservationSortField">
                            <option value="user" <?= ($_GET['reservationSortField'] ?? '')=='user'?'selected':''; ?>>User</option>
                            <option value="book" <?= ($_GET['reservationSortField'] ?? '')=='book'?'selected':''; ?>>Book</option>
                            <option value="due_date" <?= ($_GET['reservationSortField'] ?? '')=='due_date'?'selected':''; ?>>Due Date</option>
                            <option value="status" <?= ($_GET['reservationSortField'] ?? '')=='status'?'selected':''; ?>>Status</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select filter-control" name="reservationSortOrder">
                            <option value="asc" <?= ($_GET['reservationSortOrder'] ?? '')=='asc'?'selected':''; ?>>A-Z</option>
                            <option value="desc" <?= ($_GET['reservationSortOrder'] ?? '')=='desc'?'selected':''; ?>>Z-A</option>
                        </select>
                    </div>
                    <div class="col-md-2 text-end">
                        <button type="submit" class="btn btn-primary btn-sm btn-action filter-control">Search/Sort</button>
                    </div>
                </form>
                <table class="table table-striped table-hover table-sm align-middle" id="reservationsTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>User</th>
                            <th>Book</th>
                            <th>Reserved At</th>
                            <th>Due Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php foreach ($reservations as $res): ?>
                        <tr>
                            <form method="post" class="d-flex">
                                <td><?= $res['id'] ?><input type="hidden" name="reservation_id" value="<?= $res['id'] ?>"></td>
                                <td>
                                    <select name="user_id" class="form-select form-select-sm">
                                        <?php foreach ($users as $user): ?>
                                            <option value="<?= $user['id'] ?>" <?= $user['id']==$res['user_id']?'selected':''; ?>>
                                                <?= htmlspecialchars($user['first_name'].' '.$user['last_name']) ?>
                                            </option>
                                        <?php endforeach; ?>
                                    </select>
                                </td>
                                <td>
                                    <select name="book_id" class="form-select form-select-sm">
                                        <?php foreach ($books as $book): ?>
                                            <option value="<?= $book['id'] ?>" <?= $book['id']==$res['book_id']?'selected':''; ?>>
                                                <?= htmlspecialchars($book['title']) ?>
                                            </option>
                                        <?php endforeach; ?>
                                    </select>
                                </td>
                                <td><?= htmlspecialchars($res['reserved_at']) ?></td>
                                <td><input type="date" name="due_date" class="form-control form-control-sm" value="<?= htmlspecialchars($res['due_date']) ?>"></td>
                                <td>
                                    <select name="status" class="form-select form-select-sm">
                                        <option value="reserved" <?= $res['status']=='reserved'?'selected':''; ?>>Reserved</option>
                                        <option value="completed" <?= $res['status']=='completed'?'selected':''; ?>>Completed</option>
                                        <option value="canceled" <?= $res['status']=='canceled'?'selected':''; ?>>Canceled</option>
                                    </select>
                                </td>
                                <td>
                                    <button type="submit" name="edit_reservation" class="btn btn-success btn-sm btn-action">Save</button>
                                    <button type="submit" name="delete_reservation" class="btn btn-danger btn-sm btn-action" onclick="return confirm('Delete this reservation?');">Delete</button>
                                </td>
                            </form>
                        </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <!-- Add Book Modal -->
    <div class="modal fade" id="addBookModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Book</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <?php if (!empty($bookAddError)): ?>
                        <div class="error"><?= $bookAddError ?></div>
                    <?php elseif (!empty($bookAddSuccess)): ?>
                        <div class="success"><?= $bookAddSuccess ?></div>
                    <?php endif; ?>
                    <form class="crud-form" method="post">
                        <input type="text" name="title" placeholder="Title" required>
                        <input type="text" name="author" placeholder="Author" required>
                        <input type="text" name="isbn" placeholder="ISBN" required>
                        <input type="text" name="publisher" placeholder="Publisher" required>
                        <input type="number" name="year_published" placeholder="Year" required>
                        <input type="text" name="category" placeholder="Category" required>
                        <input type="text" name="cover_image" placeholder="Cover Image Path">
                        <input type="number" name="copies" placeholder="Copies" required>
                        <input type="text" name="shelf_location" placeholder="Shelf Location" required>
                        <select name="availability_status" required>
                            <option value="available">Available</option>
                            <option value="checked_out">Checked Out</option>
                            <option value="reserved">Reserved</option>
                            <option value="lost">Lost</option>
                        </select>
                        <button type="submit" name="add_book" class="btn btn-primary">Add</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Category Modal -->
    <div class="modal fade" id="addCategoryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Category</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <?php if (!empty($catAddError)): ?>
                        <div class="error"><?= $catAddError ?></div>
                    <?php elseif (!empty($catAddSuccess)): ?>
                        <div class="success"><?= $catAddSuccess ?></div>
                    <?php endif; ?>
                    <form class="crud-form" method="post">
                        <input type="text" name="category" placeholder="New Category" required>
                        <button type="submit" name="add_category" class="btn btn-primary">Add</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div class="modal fade" id="addUserModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <?php if (!empty($userAddError)): ?>
                        <div class="error"><?= $userAddError ?></div>
                    <?php elseif (!empty($userAddSuccess)): ?>
                        <div class="success"><?= $userAddSuccess ?></div>
                    <?php endif; ?>
                    <form class="crud-form" method="post">
                        <input type="text" name="first_name" placeholder="First Name" required>
                        <input type="text" name="middle_name" placeholder="Middle Name">
                        <input type="text" name="last_name" placeholder="Last Name" required>
                        <input type="email" name="email" placeholder="Email" required>
                        <input type="text" name="student_teacher_id" placeholder="Student ID" required>
                        <input type="text" name="phone" placeholder="Phone">
                        <select name="role" required>
                            <option value="student">Student</option>
                            <option value="teacher">Teacher</option>
                            <option value="admin">Admin</option>
                        </select>
                        <input type="password" name="password" placeholder="Password" required>
                        <input type="password" name="confirm_password" placeholder="Confirm Password" required>
                        <button type="submit" name="add_user" class="btn btn-primary">Add</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Reservation Modal -->
    <div class="modal fade" id="addReservationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Reservation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <?php if (!empty($reservationAddError)): ?>
                        <div class="error"><?= $reservationAddError ?></div>
                    <?php elseif (!empty($reservationAddSuccess)): ?>
                        <div class="success"><?= $reservationAddSuccess ?></div>
                    <?php endif; ?>
                    <form class="crud-form" method="post">
                        <select name="user_id" required>
                            <option value="">Select User</option>
                            <?php foreach ($users as $user): ?>
                                <option value="<?= $user['id'] ?>"><?= htmlspecialchars($user['first_name'] . ' ' . $user['last_name']) ?></option>
                            <?php endforeach; ?>
                        </select>
                        <select name="book_id" required>
                            <option value="">Select Book</option>
                            <?php foreach ($books as $book): ?>
                                <option value="<?= $book['id'] ?>"><?= htmlspecialchars($book['title']) ?></option>
                            <?php endforeach; ?>
                        </select>
                        <input type="date" name="due_date" placeholder="Due Date" required>
                        <select name="status" required>
                            <option value="reserved">Reserved</option>
                            <option value="completed">Completed</option>
                            <option value="canceled">Canceled</option>
                        </select>
                        <button type="submit" name="add_reservation" class="btn btn-primary">Add</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <?php include '../templates/footer.html'; ?>
    <script src="../js/adminPanel.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>